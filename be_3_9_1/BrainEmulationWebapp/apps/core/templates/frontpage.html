{% extends 'base.html' %}
{% load static %}

{% block title %}ThreeJS Test | {% endblock %}

{% block content %}
<!--
<div class="container">start of testing UI
   <div class="row">
      <div class="col-xs-12 col-sm-4 col-md-3 col-lg-3">
         <div class="card card-vaporwaveNeonPink">
            <div class="card-header">
              This is Vaporwave Neon Card w/ PINK base
            </div>
            <div class="card-body">
               <p class="card-text">lroeajsdjskda  aksldjajk jkn ajkd oi kjabdkjb asd . aadkjasd , akjsd a. aodh ajkn >SDSUIHANndlkBDlajkdn .</p>
               <div class="d-flex justify-content-end mt-3">
                  <a href="" class="btn btn-sm mr-2 btn-primary border-dark" type="button">
                     Details
                  </a>                    
               </div>
            </div>
         </div>
      </div> 
      <div class="col-xs-12 col-sm-4 col-md-3 col-lg-3">
         <div class="card card-vaporwaveNeonBeige">
            <div class="card-header">
              This is Vaporwave Neon Card w/ BEIGE base
            </div>
            <div class="card-body">
               <p class="card-text">lroeajsdjskda  aksldjajk jkn ajkd oi kjabdkjb asd . aadkjasd , akjsd a. aodh ajkn >SDSUIHANndlkBDlajkdn .</p>
               <div class="d-flex justify-content-end mt-3">
                  <a href="" class="btn btn-sm mr-2 btn-primary border-dark" type="button">
                     Details
                  </a>                    
               </div>
            </div>
         </div>
      </div> 
      <div class="col-xs-12 col-sm-4 col-md-3 col-lg-3">
         <div class="card card-vaporwaveNeonYellow">
            <div class="card-header">
              This is Vaporwave Neon Card w/ YELLOW base
            </div>
            <div class="card-body">
               <p class="card-text">lroeajsdjskda  aksldjajk jkn ajkd oi kjabdkjb asd . aadkjasd , akjsd a. aodh ajkn >SDSUIHANndlkBDlajkdn .</p>
               <div class="d-flex justify-content-end mt-3">
                  <a href="" class="btn btn-sm mr-2 btn-primary border-dark" type="button">
                     Details
                  </a>                    
               </div>
            </div>
         </div>
      </div>       
      
   </div>
   end of testing UI
</div>   
-->   

<div class="container-fluid" id="tip" style="display: none">
<h1 id="intro_statement" style="text-align: center">some text</h1>
   <div class="row">
      {% for org in orgs %}
           
      <div class="col-xs-12 col-sm-6 col-md-4 col-lg-4" id="{{org.slug}}" style="display: none">
         {% if org.category.slug == "startup" or org.category.slug == "sme" %}
         <div class="card card-vaporwaveNeonPink">
         {% elif org.category.slug == "lab" or org.category.slug == "foundation" %}
         <div class="card card-vaporwaveNeonBeige">
         {% elif org.category.slug == "incubator" or org.category.slug == "accelerator" or org.category.slug == "venture_capital" or org.category.slug == "investment_fund" %}
         <div class="card card-vaporwaveNeonYellow">
         {% else %}
         <div class="card card-primary">
         {% endif %}
         
            <div class="card-header">
              {{org.title}} ({{org.category}} in {{org.country_hq}})
            </div>
               <div class="card-body">
                  <p class="card-text">{{org.description}}</p>
                  <div class="text-center">
                    <a href="{% url 'org_profile' org.category.slug org.slug %}" class="btn btn-sm mr-2 btn-neonPink" type="button">
                      Details
                    </a>                    
                  </div>
                </div>
        </div>
      </div> 
      
    {% endfor %}

   </div>
</div>   





<!-- 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

<link rel="stylesheet" type="text/css" href="{% static 'styles/windows-95-ui-kit/css/pixel.css' %}" />
<script src="{% static 'styles/windows-95-ui-kit/js/pixel.js' %}" type="text/javascript"></script>

-->


<script>

   var scene; 
   var camera;
   let light1, light2, light3, light4;


   var NEUROPROSTHETICS_CANVAS;
   var canvasBounds; 
   var brain;
   var selectedBrainAreaName;
   var selectedBrainAreaObject;
   var selectedBrainAreaObject_humanReadibleName;    //retrieved later from the sql tables via django
   var selectedBrainAreaClickPosition;
   var previouslySelectedBrainArea;
  

   var colorMap_bio;
   var colorMap_tech;
   var normalMap;
   var heightMap;

   var bioMaterial;
   var techMaterial;

   var INTERSECTED;
   var raycaster;
   var loader;
   const mouse = new THREE.Vector2();

   init();
   animate();


   async function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(4, window.innerWidth / (window.innerHeight/1.5), 1, 1000);
      camera.position.z = 2.5;
      //camera.position.y = -0.06;
      //camera.lookAt( scene.position );
      scene.add(new THREE.AxesHelper(500));

      renderer = new THREE.WebGLRenderer({alpha:true});
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      //controls.enableZoom = false;
      controls.update();


      //associating an HTML element with the three.js content
      renderer.domElement.id = 'NEUROPROSTHETICS_CANVAS';
      renderer.outputEncoding = THREE.sRGBEncoding;

      //renderer.setPixelRatio( window.devicePixelRatio );
      renderer.setSize(window.innerWidth, window.innerHeight/1.5);
      document.body.appendChild(renderer.domElement); 
      
      
      //adding light. Code is inspired by https://github.com/mrdoob/three.js/blob/master/examples/webgl_lights_pointlights.html
		const sphere = new THREE.SphereGeometry( 0.0015, 16, 8 );
      const clock = new THREE.Clock();

      light1 = new THREE.PointLight( 0xff0040, 2, 50 );
      light1.add( new THREE.Mesh( sphere, new THREE.MeshBasicMaterial( { color: 0xff0040 } ) ) );
      scene.add( light1 );

      light2 = new THREE.PointLight( 0x0040ff, 2, 50 );
      light2.add( new THREE.Mesh( sphere, new THREE.MeshBasicMaterial( { color: 0x0040ff } ) ) );
      scene.add( light2 );

      light3 = new THREE.PointLight( 0xffaa00, 2, 50 );
      light3.add( new THREE.Mesh( sphere, new THREE.MeshBasicMaterial( { color: 0xffaa00 } ) ) );
      scene.add( light3 );


   //figuring out whether some part of the brain has been clicked on        
      raycaster = new THREE.Raycaster();
      document.addEventListener( 'mousemove', onDocumentMouseMove );
      //NEUROPROSTHETICS_CANVAS.addEventListener('click', onCanvasClick);

   //resize and recentre the brain to fit window (responsive design) from https://subscription.packtpub.com/book/web_development/9781784392215/1/ch01lvl1sec15/automatically-resize-the-output-when-browser-size-changes
      window.addEventListener('resize', onResize, false);  
      
   //loading texture for later brain area selection (when user selects a brain area this texture will be applied to it, implying that the area has been computerized)
      const textureLoader = new THREE.TextureLoader();
   //textures & maps
      colorMap_bio = textureLoader.load("{% static 'content/3d/textures_materials/bio_brain/brain_colorTexture.png' %}");
      colorMap_tech = textureLoader.load("{% static 'content/3d/textures_materials/color_map_JS-2-2021-05-07-12-27-26-Seamless.png' %}");
      //normalMap = textureLoader.load("{% static 'content/3d/textures_materials/normal_map_JS-2-2021-05-07-12-27-26-Seamless-Normal.png' %}");
      //heightMap = textureLoader.load("{% static 'content/3d/textures_materials/height_map_JS-2-2021-05-07-12-27-26-Seamless.png' %}");
   //assigning them to materials
      bioMaterial = new THREE.MeshStandardMaterial ({map:colorMap_bio});
      //techMaterial = new THREE.MeshStandardMaterial({map: colorMap_tech});  

   //loading the brain mesh + tech material ( async with a promise so that the animation is only applied when the model is loaded and so no undefined errors are thrown (code from https://discourse.threejs.org/t/most-simple-way-to-wait-loading-in-gltf-loader/13896/5))
      loader = new THREE.GLTFLoader();
      loader.load(
         "{% static 'content/3d/brain_org_Models_E0112A093/tech_brain_w_material.glb' %}",
         function (gltf) {
            brain = gltf.scene;
            scene.add(brain);
            
            //setting the brain to have bio texture (to be changed into tech texture when clicked)
         brain.traverse(function(obj){
            if(obj.isMesh && obj.material)
              obj.material.map = colorMap_bio;
            });
            //animate();
         },
         function (xhr) {
            console.log((xhr.loaded / xhr.total * 100) + '% loaded');
         },
         function (error) {
            console.error(error);
         }
      );

      
   }

   function onResize() {

      camera.aspect = window.innerWidth / (window.innerHeight/1.5);
      camera.updateProjectionMatrix();
      controls.update();

      renderer.setSize(window.innerWidth, (window.innerHeight/1.5));
      
      //updating the #tip div's location when the window is resized. For more info on this div see method onBrainAreaClicked
      $('#tip').css({ left: 0, top: ($('#NEUROPROSTHETICS_CANVAS').offset().top + $('#NEUROPROSTHETICS_CANVAS').outerHeight(true))});

   }
   
   function onCanvasClick(){
      //only firing the event if the brain was clickled. I.e. not when clicked inside the canvas but outside the brain
      if(INTERSECTED){
         //if any brain area was clicked, then when the next area is clicked the old one should return to original color/texture
         if(previouslySelectedBrainArea) previouslySelectedBrainArea.material.emissive.setHex( INTERSECTED.currentHex );
         INTERSECTED.material.emissive.setHex( 0x0000FF )
         
         onBrainAreaClicked (INTERSECTED.name);

         previouslySelectedBrainArea = INTERSECTED;
         INTERSECTED = null;
      }
      else{
         onBrainAreaClicked ("peripheral_NS");
      }
   }
   
   function onBrainAreaClicked(brainAreaName){
      /* texture from  <a href='https://pngtree.com/free-backgrounds'>free background photos from pngtree.com</a>
      var wireframe = new THREE.MeshBasicMaterial({
         color: 0x00000,
         wireframe: true,
         transparent: false,
         opacity: 1.0      
      });
      */
      
      //if its the same brain area as previously selected do nothing
      if(brainAreaName != selectedBrainAreaName){
         selectedBrainAreaName = brainAreaName;
         selectedBrainAreaObject = brain.getObjectByName(selectedBrainAreaName);
         //selectedBrainAreaObject.scale.multiplyScalar(1.1);
         console.log("i clicked on: " + selectedBrainAreaObject.name);
         
         renderOrgInfo();

      }
   }

   
   function renderOrgInfo(){
         //calculating the Y position to place the text at as the sum of canvas hight + its offset from top of the page. The code is based on https://stackoverflow.com/questions/20827030/calculate-bottom-left-corner-of-a-div
         $('#tip').css({ left: 0, top: ($('#NEUROPROSTHETICS_CANVAS').offset().top + $('#NEUROPROSTHETICS_CANVAS').outerHeight(true))});      

         //organizing the HTML so that the #tip content appears on the same level as and after #NEUROPROSTHETICS_CANVAS. Using this jquery method for that https://api.jquery.com/insertafter/
         $('#tip').insertAfter( "#NEUROPROSTHETICS_CANVAS" );

         //changing the #tip element to show the info related to the selected part of the brain. The code is partially based on https://stackoverflow.com/questions/54410532/how-to-correctly-position-html-elements-in-three-js-coordinate-system
         $('#tip').css('display', 'block'); //(inactive) targetting the sub-element of the div id:#tip by using a jquery selector syntax explained here https://stackoverflow.com/questions/6665246/nested-id-in-jquery-selector
         
         //matching the brain area name (set in blender for the GLTF child objects) with django model. The GLTF name is a slug of the brain area in django model so it will be used to retrieve full name of the brain part. Text to be placed in the intro statement.
         {% for brainRegion in brainRegions %}
            if(selectedBrainAreaObject.name == '{{brainRegion.slug}}')
            selectedBrainAreaObject_humanReadibleName = '{{brainRegion.name}}'
         {% endfor %}
         $('#intro_statement').text(selectedBrainAreaObject_humanReadibleName + " emulations"); //Here I am simply putting the brain region name (in a readable format) below the 3d canvas

         //Reviewing if the orgs work on the selected brain area, and only if they do I shell display them in the html
         {% for org in orgs %}
            //simple reset. If an org has been displayed, this statement will make it invisible again when clicking on a brain region
            $('#{{org.slug}}').css("display", "none");
            {% for org_BR in orgBrainRegions %}
               //if the name of the org (in the current iteration of the for loop) exists inside the table which associates a brain region to an org, then continue...
               if('{{org.title}}' == '{{org_BR.org_name.title}}'){
                  //if the org is associated with (works on) the selected brain region, display it
                  if('{{org_BR.brain_region_name.name}}' == selectedBrainAreaObject_humanReadibleName){
                     $('#{{org.slug}}').css("display", "block");
                  }
               }
            {% endfor %}
         {% endfor %}

   }

   function onDocumentMouseMove(event) {
      
      event.preventDefault();

      //responsive mouse location for selecting brain areas (when changing window size/devices or when canvas is not full screen) based on https://stackoverflow.com/questions/36880033/clicking-objects-in-three-js-when-the-canvas-is-not-full-screen-r74
      //[why done this way] need to getElementById each time as ThreeJS generates a canvas for the objects used after they are loaded
      NEUROPROSTHETICS_CANVAS = document.getElementById("NEUROPROSTHETICS_CANVAS");
      canvasBounds = NEUROPROSTHETICS_CANVAS.getBoundingClientRect();
      mouse.x = ( ( event.clientX - canvasBounds.left ) / ( canvasBounds.right - canvasBounds.left ) ) * 2 - 1;
      mouse.y = - ( ( event.clientY - canvasBounds.top ) / ( canvasBounds.bottom - canvasBounds.top) ) * 2 + 1;

   }


   function animate() {
      requestAnimationFrame(animate);

      render();

      //brain.rotation.x += 0.01;
      //brain.rotation.y += 0.01;
      //brain.rotation.z += 0.01;



   }


   function render() {
      camera.updateMatrixWorld();
     	controls.update();
      
      
      // find intersections where mouse hovers over a brain area (code from https://github.com/mrdoob/three.js/blob/master/examples/webgl_interactive_cubes.html)    
		raycaster.setFromCamera( mouse, camera );
		const intersects = raycaster.intersectObjects( brain.children );
		

      if ( intersects.length > 0 ) {
         if ( INTERSECTED != intersects[ 0 ].object ) {
            if ( INTERSECTED ) INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );

            INTERSECTED = intersects[ 0 ].object;
            INTERSECTED.material = INTERSECTED.material.clone(); //must clone the material into a new instance otherwise (since 1 material is shared across all brain regions) it would change the surface of all brain regions. Code inspired by https://discourse.threejs.org/t/manipulate-child-mesh-material-without-affecting-parent-object/20440/3
            INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
            INTERSECTED.material.emissive.setHex( 0xf9d1fb );
            

            NEUROPROSTHETICS_CANVAS.addEventListener('click', function(){
               //only firing the event if the brain was clickled. I.e. not when clicked inside the canvas but outside the brain
               if(INTERSECTED){
                  //if any brain area was already clicked, then when the next area is clicked the old one should return to original color/texture
                  if(previouslySelectedBrainArea){
                     previouslySelectedBrainArea.material.emissive.setHex( INTERSECTED.currentHex );
                     previouslySelectedBrainArea.material.map = colorMap_bio;
                  }
                  //INTERSECTED.material.emissive.setHex( 0x0000FF );
                  INTERSECTED.material.map = colorMap_tech;
                  INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex ); //so that after clicking a brain part it will stop being highlighted

                  onBrainAreaClicked (INTERSECTED.name);

                  previouslySelectedBrainArea = INTERSECTED;
                  INTERSECTED = null;
               }
               /* logic for clicking on peripheral nervous system !!not going to work due to the if this is in. The click won't be registered if not intersected!!
               if(!INTERSECTED){
                  if(previouslySelectedBrainArea) previouslySelectedBrainArea.material.emissive.setHex( INTERSECTED.currentHex );
                  previouslySelectedBrainArea = null;
                  onBrainAreaClicked("peripheral_NS");

               }
               */
               }
            );    
         }
		} else {
			if ( INTERSECTED )   INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );            
			INTERSECTED = null;
		}
      
      
      const time = Date.now() * 0.0005;
		
      light1.position.x = Math.sin( time * 0.7 ) * 0.1;
      light1.position.y = Math.cos( time * 0.5 ) * 0.1;
      light1.position.z = Math.cos( time * 0.3 ) * 0.2;

      light2.position.x = Math.cos( time * 0.3 ) * 0.2;
      light2.position.y = Math.sin( time * 0.5 ) * 0.1;
      light2.position.z = Math.sin( time * 0.7 ) * 0.1;

      light3.position.x = Math.sin( time * 0.3 ) * 0.1;
      light3.position.y = Math.cos( time * 0.7 ) * 0.2;
      light3.position.z = Math.sin( time * 0.5 ) * 0.1;

      renderer.render(scene, camera);
   }

   
   // this utility function allows you to use any three.js loader with promises and async/await
   function modelLoader(url) {
      return new Promise((resolve, reject) => {
         loader.load(
            url,
            data => resolve(data),
            function (xhr) {
               console.log((xhr.loaded / xhr.total * 100) + '% loaded');
            },
            function (error) {
               console.error(error);
            }
         );
      });
   }

   

   init().catch(error => {
      console.error(error);
   });


</script>




{% endblock %}